---
title: Configuring IPsec with CredHub
owner: Platform Security & Compliance Team
---

<strong><%= modified_date %></strong>

This topic describes how to create a <%= vars.product_full %> manifest to be used with CredHub.
The certificates can be generated by CredHub and monitored by Ops Manager.

<p class="note warning"><strong>Warning:</strong> Certificate rotation cannot be done through CredHub rotation mechanism. You need to manually generate new certificates.
For more information, see <a href="#credhub_cert_rotation">Rotating Certificates with CredHub</a>.
</p>

<CHRIS: PREREQUISITES SECTION?
- CERTIFICATES CREATED BY CREDHUB
- BOSH CLI
- CredHub CLI
>




## <a id="credhub_runtime_config"></a>Configure Runtime Config

1. In the runtime-config for IPsec, add variables to use the CA and instance certificate. <CHRIS: Are these certificates generated by CredHub? How are they created? Is this a prerequisite?>



  	<p class="note warning">
      	<strong>Warning: </strong> The instance certificate must be signed by the CA certificate.
			  Under <code>options</code> for the instance certificate variable, set <code>ca</code> to the
				variable name of the defined CA certificate.<br><br>

				The name of the variable must be prefixed with <code>/ipsec_addon/</code>.
  	</p>

  	Example of an <%= vars.product_short %> Runtime Config:

		releases:
		- name: ipsec
		  version: <VERSION>

		variables:
		- name: /ipsec_addon/<ROOT-CA-1>
		   type: certificate
		   options:
		      is_ca: true
		      common_name: ipsec_addon_<ROOT-CA-1>

		- name: /ipsec_addon/<INSTANCE-CERT-1>
		   type: certificate
		   options:
		     ca: /ipsec_addon_<ROOT-CA-1>
		     common_name: ipsec_addon_<INSTANCE-CERT-1>

		addons:
		- name: ipsec-addon
		    jobs:
		    - name: ipsec
		      release: ipsec
		      properties:
		        ipsec:
		          optional: false
		          ipsec_subnets:
		          - 10.0.1.1/20
		          no_ipsec_subnets:
		          - 10.0.1.10/32  # bosh director
		          - 10.0.1.4/32  # ops managers
		          instance_certificate: ((/ipsec_addon/<INSTANCE-CERT-1>.private_key))
		          instance_private_key: ((/ipsec_addon/<INSTANCE-CERT-1>.certificate))
		          ca_certificates:
		            - ((/ipsec_addon/<ROOT-CA-1>.ca))
		    include:
		      stemcell:
		      - os: ubuntu-trusty
		      - os: ubuntu-xenial

	Where:
	* `VERSION` is the version of IPsec you are using.
	* `ROOT-CA-1` is the variable name and accessor for the `.ca` root certificate.
	* `INSTANCE-CERT-1` is the instance variable name and accessor for the `.private_key` and `.certificate`.


## <a id="credhub_cert_rotation"></a>Rotating Certificates with CredHub
To rotate your certificates using CredHub, follow this procedure:

1. Use the BOSH CLI to download the IPsec Runtime Config:

		bosh -e BOSH-ENVIRONMENT runtime-config > PATH-TO-SAVE-THE-RUNTIME-CONFIG

	Where:
	* `BOSH-ENVIRONMENT` is <CHRIS: the alias for your BOSH Director??>
	* `PATH-TO-SAVE-THE-RUNTIME-CONFIG` is the location where you want to save the runtime configuration.

1. SSH onto the Ops Manager VM. <CHRIS: Need somehing similar to https://docs.pivotal.io/platform/2-9/customizing/ops-man-api.html#uaa>

1. Target the CredHub api server (The CredHub api is the bosh director).

	For example:
	<pre class="terminal">
  ~$ credhub api --server 10.0.0.5:8844 --ca-cert /var/tempest/workspaces/default/root\_ca\_certificate
	Setting the target url: https<span>:</span>//10.0.0.5:8844
	</pre>

1. Retrieve the UAA admin credential and login to CredHub
1. Login to Ops Manager
1. Navigate to the **Credentials** tab on the **BOSH Director** tile.
1. Open "UAA Admin User Credentials" to retrieve the credentials
1. Login to CredHub using the retrieved credentials:

	<pre class="terminal">
  ~$ credhub login
	username: admin
	password: **************************************
	Login Successful
	</pre>

1. Use the CredHub CLI to verify that the new certificate variable names are not already in use:

		~$ credhub find -n /ipsec_addon/<ROOT-CA-2>
		~$ credhub find -n /ipsec_addon/<INSTANCE-CERT-2>

	Where:
	* `ROOT-CA-2` is the variable name and accessor for the new `.ca` root certificate.
	* `INSTANCE-CERT-2` is the instance variable name and accessor for the new `.private_key` and `.certificate`.


	For example:

	<pre class="terminal">
	~$ credhub find -n /ipsec_addon/root-ca_1
	No credentials exist which match the provided parameters

	~$ credhub find -n /ipsec_addon/instance_cert_2
	No credentials exist which match the provided parameters
	</pre>

	<p class="note"><strong>Note:</strong> If certificates already exist with the new variable names you have
		selected, you must use a different name.
	</p>

1. Add the new set of variables for the CA certificate, instance certicate,
	and private key to your <%= vars.product_short %> Runtime Config:

		variables:
		- name: /ipsec_addon/<ROOT-CA-1>
		   type: certificate
		   options:
		      is_ca: true
		      common_name: ipsec_addon_<ROOT-CA-1>

		- name: /ipsec_addon/<INSTANCE-CERT-1>
		   type: certificate
		   options:
		     ca: /ipsec_addon/<ROOT-CA-1>
		     common_name: ipsec_addon_<INSTANCE-CERT-1>

		- name: /ipsec_addon/<ROOT-CA-2>
		   type: certificate
		   options:
		      is_ca: true
		      common_name: ipsec_addon_<ROOT-CA-2>

		- name: /ipsec_addon/<INSTANCE-CERT-2>
		   type: certificate
		   options:
		     ca: /ipsec_addon/<ROOT-CA-2>
		     common_name: ipsec_addon_<INSTANCE-CERT-2>

	Where:
	* `ROOT-CA-1` is the variable name and accessor for the current `.ca` root certificate.
	* `INSTANCE-CERT-1` is the instance variable name and accessor for the current `.private_key` and `.certificate`.
	* `ROOT-CA-2` is the variable name and accessor for the new `.ca` root certificate.
	* `INSTANCE-CERT-2` is the instance variable name and accessor for the new `.private_key` and `.certificate`.













1. Add a new item in ipsec.ca\_certificates with the new variable name and accessor to the certificate.

	For Example:

	```
	addons:
  - name: ipsec-addon
      jobs:
      - name: ipsec
        release: ipsec
        properties:
          ipsec:
            optional: false
            ipsec\_subnets:
            \- 10.0.1.1/20
            no\_ipsec\_subnets:
            \- 10.0.1.10/32  # bosh director
            \- 10.0.1.4/32 # ops managers
            instance\_certificate: ((/ipsec_addon/instance_cert_1.private_key))
            instance\_private\_key: ((/ipsec_addon/instance_cert_1.certificate))
            <strong>ca\_certificates</strong>:
              \- ((/ipsec_addon/root_ca_1.certificate))
              <strong>\- ((/ipsec_addon/root_ca_2.certificate))</strong>
	```

1. Update the runtime config and apply changes to the entire foundation
       Verify the output when updating the runtime-config:

		<pre class="terminal">
		  addons:
		  - name: ipsec-addon
		    properties:
		      ipsec:
		        ca_certificates:
		+       - "<redacted>"

		  variables:
		+ - name: "/ipsec_addon/root_ca_2"
		+   options:
		+     common_name: ipsec_addon_root_ca_2
		+     is_ca: true
		+   type: certificate
		+ - name: "/ipsec_addon/instance_cert_2"
		+   options:
		+     ca: "/ipsec_addon/root_ca_2"
		+     common_name: ipsec_addon_instance_cert_2
		+   type: certificate
		</pre>

1. - Set instance\_certificate with the new variable name and accessor to the certificate.
       - Set instance\_key with the new variable name and accessor to the private key.

       Example:
       <pre>
        properties:
          ipsec:
            optional: false
            ipsec\_subnets:
            \- 10.0.1.1/20
            no\_ipsec\_subnets:
            \- 10.0.1.10/32  # bosh director
            \- 10.0.1.4/32 # ops managers
            <strong>instance\_certificate: ((/ipsec_addon/instance_cert_2.private_key))</strong>
            <strong>instance\_private\_key: ((/ipsec_addon/instance_cert_2.certificate))</strong>
            ca\_certificates:
              \- ((/ipsec_addon/root_ca_1.certificate))
              \- ((/ipsec_addon/root_ca_2.certificate))
       </pre>

1. Update the runtime config and apply changes to the entire foundation
       Verify the output when updating the runtime-config:
		<pre class="terminal">
		  addons:
		  - name: ipsec-addon
		    properties:
		      ipsec:
		-       instance_certificate: "<redacted>"
		+       instance_certificate: "<redacted>"
		-       instance_private_key: "<redacted>"
		+       instance_private_key: "<redacted>"
		</pre>

1. - Remove the old ca\_certificates cert entry
		 Example: /ipsec_addon/root_ca_1

       - Remove the old set of certificate variables
         Example: /ipsec_addon/root_ca_1, /ipsec_addon/instance_cert_1

         Example: Below should not have references to the old certs
	     <pre>
	      <strong>variables:</strong>
		  \- name: /ipsec_addon/root_ca_2
		     type: certificate
		     options:
		        is_ca: true
		        common_name: ipsec_addon_root_ca_2

		  \- name: /ipsec_addon/instance_cert_2
		     type: certificate
		     options:
		       ca: /ipsec_addon/root_ca_2
		       common_name: ipsec_addon_instance_cert_2

		  addons:
		  \- name: ipsec-addon
		      <strong>jobs</strong>:
		      \- <strong>name</strong>: ipsec
		        release: ipsec
		        properties:
		          ipsec:
		            <strong>optional</strong>: false
		            <strong>ipsec\_subnets</strong>:
		            \- 10.0.1.1/20
		            <strong>no\_ipsec\_subnets</strong>:
		            \- 10.0.1.10/32  # bosh director
		            \- 10.0.1.4/32 # ops managers
		            <strong>instance\_certificate</strong>: ((/ipsec_addon/instance_cert_2.private_key))
		            <strong>instance\_private\_key</strong>: ((/ipsec_addon/instance_cert_2.certificate))
		            <strong>ca\_certificates</strong>:
		              \- ((/ipsec_addon/root_ca_2.certificate))
		      include:
		        stemcell:
		        - <strong>os</strong>: ubuntu-trusty
		        - <strong>os</strong>: ubuntu-xenial
	     </pre>


1. Update the runtime config and apply changes to the entire foundation
       Verify the output when updating the runtime-config:
		<pre class="terminal">
		  addons:
		  - name: ipsec-addon
		    properties:
		      ipsec:
		        ca_certificates:
		-       - "<redacted>"

		  variables:
		- - name: "/ipsec_addon/root_ca_1"
		-   options:
		-     common_name: ipsec_addon_root_ca_1
		-     is_ca: true
		-   type: certificate
		- - name: "/ipsec_addon/instance_cert_1"
		-   options:
		-     ca: "/ipsec_addon/root_ca_1"
		-     common_name: ipsec_addon_instance_cert_1
		-   type: certificate
		</pre>

1. Remove the set of certificates from CredHub

	 	credhub delete -n /ipsec_addon/root_ca_1
		credhub delete -n /ipsec_addon/instance_cert_1
